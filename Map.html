<html>
  <head>
  <meta http-equiv="CONTENT-TYPE" content="text/html; charset=UTF-8" />
  <link href="misc/w3.css" type="text/css" rel="stylesheet" />
  <link href="misc/w3-theme-amber.css" type="text/css" rel="stylesheet" />
  <TITLE></TITLE>
  <style>
    body {
      padding: 0;
    }

    table {
      text-align: center;
    }

    #main-menu {
      position: fixed;
      left: 4px;
      top: 4px;
      width: 5px;
      height: 5px;
      border: 1px solid black;
    }

    #main-menu:hover {
      width: auto;
      height: auto;
    }

    #map {
      border-collapse: collapse;
      max-height: 100vh;
      overflow: hidden;
      background-color: darkslateblue;
    }

    #map>tbody>tr>td {
      padding: 8px;
    }

    .shakal {
      width:auto !important;
      min-width:5px !important;
    }

    .map-border {
      background-color: lightgrey;
      border: 1px solid black;
    }

    .planet {
      border-collapse: collapse;
      background-color: white;
      border: 1px solid black;
    }

    .planet>tbody>tr {
      height: 32px;
    }

    .planet tr td {
      border: 1px solid black;
      width: 64px;
      max-width: 64px;
    }
    
    .cell td {
      width: 49%;
      height: 26px;
      border: 0 !important;
      background-size:cover;
    }

    .planet .belongs {
      height: 19px;
    }

    .planet .name {
      overflow: hidden;
    }

    .planet .affinities, .planet .resources {
      height: 22px;
    }

    .affinities>td, .resources>td {
      width: 25% !important;
    }

    table.empire {
      border: 1px solid black;
      border-collapse: collapse;
      width: 33%;
      text-align: center;
      background-color: white;
    }

    table.empire>tbody>tr>td {
      border: 1px solid black;
      width: 25%;
    }

    .empire select {
      background-color: transparent;
      border: 0;
      appearance: none;
      text-align: center;
      width: 100%;
    }

    .мечник     { background-image: url(images/units/мечник.png); }
    .ладья      { background-image: url(images/units/ладья.png); }
    .летучий    { background-image: url(images/units/летучий.png); }

    .building   { background-image: url(images/buildings/building.png); }
    .Артефакт   { background-image: url(images/buildings/Артефакт.png); }
    .Столица    { background-image: url(images/buildings/Столица.png); }
    .Ферма      { background-image: url(images/buildings/Ферма.png); }
    .Шахта      { background-image: url(images/buildings/Шахта.png); }
    .Храм       { background-image: url(images/buildings/Храм.png); }
    
    /* биомы */
    .лес          { background-color: #808000aa; }
    .пустыня      { background-color: #ffcc00aa; }
    .льды         { background-color: #99ccffaa; }
    .пустошь      { background-color: #c0c0c0aa; }

    .Асгард       { background-color: #00f000aa; }
    .Муспелльхейм { background-color: #ff6600aa; }
    .Нифльхейм    { background-color: #00ffffaa; }
    .Хельхейм     { background-color: #808080aa; }

    .небо         { background:white;           }

    .цвет-боги    { background:lightyellow;     }
    .цвет-огонь   { background:lightcoral;      color: white;}
    .цвет-лёд     { background:lightblue;       }
    .цвет-смерть  { background:grey;            color: white;}

    .цвет-еда     { background:green;           color: white;}
    .цвет-руда    { background:sandybrown;      color: white;}
    .цвет-души    { background:lightgrey;       }

    #image_tests td {
      height: 26px;
      width: 28px;
      background-color: white;
    }
    
  </style>

</head>
<script>
  
</script>

<body class="w3-theme-l2 w3-padding" style="overflow:auto">

  <div id="allPage">
    <style id="empires-stylesheet"></style>
    <table id="map" contenteditable="true"></table>
    <br><br><br>
    <div id="empires-list" contenteditable="true"></div>
  </div>

    <br>
    <div id="main-menu-" hidden2>
      <button onclick="savePage()">Save</button>
      <button onclick="loadPage()">Load</button>
    </div>
    <br>
  
    <div id="planet-template" hidden>
      <table class="planet" id="Земля">
        <tr class="affinities" colspan=4>
          <td class="цвет-боги  "></td>
          <td class="цвет-огонь "></td>
          <td class="цвет-лёд   "></td>
          <td class="цвет-смерть"></td>
        </tr>
        <tr>
          <td colspan=2>
            <table class="cell">
              <td>&nbsp;</td>
              <td>&nbsp;</td>
            </table>
          </td>
          <td colspan=2>
            <table class="cell">
              <td>&nbsp;</td>
              <td>&nbsp;</td>
            </table>
          </td>
        </tr>
        <tr>
          <td colspan=2>
            <table class="cell">
              <td>&nbsp;</td>
              <td>&nbsp;</td>
            </table>
          </td>
          <td colspan=2>
            <table class="cell">
              <td>&nbsp;</td>
              <td>&nbsp;</td>
            </table>
          </td>
        </tr>
        <tr class="belongs"><td class="name" colspan=4></td></tr>
        <tr class="resources" colspan=4>
          <td class="цвет-еда"  ></td>
          <td class="цвет-руда" ></td>
          <td class="цвет-души" ></td>
          <td class="цвет-боги" ></td>
        </tr>
      </table>
    </div>

    <div id="empire-template" hidden2 contenteditable="true">
      <table id="Империянейм" class="empire">
        <tbody>
          <tr><th class="empire-name" colspan=4>Империянейм</th></tr>
          <tr>
            <td>Цвет</td>
            <td>Родной мир</td>
            <td>Тип магии</td>
            <td>Биом</tdБ>
          </tr>
          <tr>
            <td class="empire-color">red</td>
            <td onclick="choosingHomeworld.start(this)">&nbsp;</td>
            <td>
              <select name="">
                <option value="Боги">Боги</option>
                <option value="Огонь">Огонь</option>
                <option value="Лед">Лед</option>
                <option value="Смерть">Смерть</option>
              </select>
            </td>
            <td>
              <select name="">
                <option value="лес">Лес</option>
                <option value="пустыня">Пустыня</option>
                <option value="льды">Льды</option>
                <option value="пустошь">Пустошь</option>
                <!-- <option value="Асгард">Асгард</option>
                <option value="Муспелльхейм">Муспелльхейм</option>
                <option value="Нифльхейм">Нифльхейм</option>
                <option value="Хельхейм">Хельхейм</option> -->
              </select>
            </td>
          </tr>
          <tr><td colspan="4">&nbsp;</td></tr>
          <tr>
            <td>Еда</td>
            <td class="food-income">0</td>
            <td>Руда</td>
            <td class="ore-income" >0</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div id="unit-template" hidden></div>
    <div id="building-template" hidden></div>

    <br><table id="image_tests">
      <tr id="buildings_test"></tr>
      <tr id="units_test"></tr>
    </table>

    <a id='downloadhref' hidden download="map.AnRSave.htm"></a>
</body>

<script>
  //Divine, Fire, Ice, Necro

  const ROWS_COUNT = 6
  const COLS_COUNT = 12

  const LAYERS_COUNT = 4
  const CELLS_COUNT = 2

  const EObjTypes = {
    biome     : 'biome',
    unit      : 'unit',
    building  : 'building',
  }

  const EResourceTypes = {
    food : 'food',
    metal : 'metal',
    souls : 'souls',
    pantheon : 'pantheon',
  }

  const EBiomeSpecials = {
    isSky: "небо",
    //advanced biome
    isAdv: "улучш.",
  }

  const INITIAL_RESOURCES = {
    PLANET: [0, 0, 3, 0],
    EMPIRE: [5, 5, 0, 0]
  }
  const BASE_FOOD   = 2
  const BASE_METAL  = 2
  //food modifier, gold?/metal modifier, affinity string, special
  const EBiomes = {
    list: {
      'лес':          [2, 0, 'D'    , []  ],
      'пустыня':      [1, 0, 'F'    , []  ],
      'льды':         [1, 0, 'I'    , []  ],
      'пустошь':      [0, 1, 'N'    , []  ],

      'Асгард':       [2, 0, 'DD'   , []  ],
      'Муспелльхейм': [1, 1, 'FFFF' , []  ],
      'Нифльхейм':    [1, 1, 'IIII' , []  ],
      'Хельхейм':     [0, 3, 'NNN'  , []  ],

      'небо'        : [0, 0, ''     , ['небо']  ],
      'цвет-боги'   : [0, 0, ''     , ['небо']  ],
      'цвет-огонь'  : [0, 0, ''     , ['небо']  ],
      'цвет-лёд'    : [0, 0, ''     , ['небо']  ],
      'цвет-смерть' : [0, 0, ''     , ['небо']  ],
    },
    base: [
      'лес',    
      'пустыня',
      'льды'  ,
      'пустошь',
    ],
    relations: {
      'лес':          [1, 0],
      'Асгард':       [2, 0],
      'цвет-боги'   : [1, 0],

      'пустыня':      [0, 1],
      'Муспелльхейм': [0, 2],
      'цвет-огонь'  : [0, 1],

      'льды':         [0, -1],
      'Нифльхейм':    [0, -2],
      'цвет-лёд'    : [0, -1],
      
      'пустошь':      [-1, 0],
      'Хельхейм':     [-2, 0],
      'цвет-смерть' : [-1, 0],

      'небо'        : [0, 0],
    }
  }

  // ATK, DEF, MAINTANCE, SPECIAL
  const EUnits = {
    list: {
      "мечник"  : [],
      "ладья"   : [],
      "летучий" : [],
      // Divine
      // Fire
      // Ice
      // Necromancy
    }
  }

  //TODO add units/buildings table for visual testing
  // prereq, cost, completionEffects[resources, affinities, other], lastingEffects (same array)
  const EBuildings = {
    list: {
      //pregen
      "Артефакт"       : ["", 0, [], []],

      "Столица"       : ["", 0, [], []],
      "Ферма"         : ["", 0, [], []],
      "Шахта"         : ["", 0, [], []],
      // Divine
      "Храм"          : ["", 0, [], []],
      // Fire
      // Ice
      // Necromancy
    }
  }

  const EAffinities = {
    dict: {
      'D': 0,
      'F': 1,
      'I': 2,
      'N': 3,
    }
  }

  const mapEditorData = {
    mode: null,
    brush: null
  }

  const log = console.log
  HTMLElement.prototype.qs = HTMLElement.prototype.querySelector
  HTMLElement.prototype.qsa = HTMLElement.prototype.querySelectorAll

  const TPlanet = {
    populate: function(planet, x, y) {
      let i
      //belongs to
      planet.id = `${x}_${y}`
      planet.rows[3].cells[0].innerHTML = planet.id 

      //sky
      i = 1
      for(let j=0; j<CELLS_COUNT; j++)  {
        setBiome(planet.rows[i].cells[j], 'небо')
      }
      
      //ground
      i = 2
      for(let j=0; j<CELLS_COUNT; j++)  {
        setBiome(planet.rows[i].cells[j], EBiomes.base[getRandomInt(0,3)])
      }

      TPlanet.updateResources(planet, INITIAL_RESOURCES.PLANET)
    },
    params: {
      update: function (planetName, resourceArray, affinityString, revert = false) {
        TPlanet.updateResources (planetName, resourceArray, revert)
        TPlanet.updateAffinity  (planetName, affinityString, revert)
      },
    },
    //food, metal, two types of souls
    updateResources: function (planet, resourceArray, revert = false) {
      const list = planet.querySelector('.resources').children
      for (let i in list) {
        if(!resourceArray[i]) continue
        if(!list[i].innerText) list[i].innerText = 0
        list[i].innerText = +list[i].innerText + resourceArray[i]
      }
    }, 
    updateAffinity: function  (planet, affinityString, revert = false) {
      affinityString = affinityString.trim()
      if(!affinityString) return
      // let total = {}
      // const d = affinityString
      //   .toUpperCase()
      //   .split('')
      //   .forEach(x => total[x] ? total[x]+=1 : total[x]=1 )
      const target = planet.querySelector('.affinities').children[EAffinities.dict[affinityString.charAt()]]
      if(!target.innerText) target.innerText = 0
      if(!revert)
        target.innerText = +target.innerText + affinityString.length
      else
        target.innerText = +target.innerText - affinityString.length

      if(+target.innerText <= 0) target.innerText = ''
    }
  }

  class TPlanets {
    constructor() {
      this.planets = []
    }

    newPlanet(x, y) {
      const p = {
        name: `${x}_${y}`,
        x, y,
        owner: null,
        cells: [
          [ [null,null, 'небо'], [null,null, 'небо'] ],
          [ [null,null, ''], [null,null, ''] ],
        ]
      }
    }
  }

  function getEl(name) {
    return document.getElementById(name)
  }

  function getRandomInt(min, maxInclusive) {
    min = Math.ceil(min);
    maxInclusive = Math.floor(maxInclusive);
    return Math.floor(Math.random() * (maxInclusive - min + 1)) + min;
  }

  function onCellClick() {
    let t, objs
    if(this.nextSibling.nextSibling) {
      //left, building
      //if building exists - upgrade?
      objs = Object.keys(EBuildings.list)
      // this.innerHTML = '<select>' + objs.map(e => `<option value=${e}>${e}`).join('\n')
      t = prompt("Новое здание:\n- - удалить\n"+objs.map((e,i)=>i+' - '+e).join('\n'))
      if(t && objs[t]) {
        setBuilding(this, objs[t])
      } else if(t == '-') {
        setBuilding(this, '')
      }
    } else {
      // right, unit
      objs = Object.keys(EUnits.list)
      t = prompt("Новый юнит:\n- - удалить\n"+objs.map((e,i)=>i+' - '+e).join('\n'))
      if(t && objs[t]) {
        setUnit(this, objs[t])
      } else if(t == '-') {
        setUnit(this, '')
      }
    }
    return

    switch (mapEditorData.mode) {
      case 'biomes':
        if(!mapEditorData.brush) 
          this.classList = "";
        else
          this.classList = mapEditorData.brush;
        break;
      case 'units':
        if(applyUnit == "Сброс") 
          getUnit(this).innerHTML = "";
        else
          getUnit(this).innerHTML = createUnit(applyUnit)
        break;
      case 'empires':
        if(applyEmpire == "Сброс") 
          setEmpire(this, "");
        else
          setEmpire(this, applyEmpire);
        break;
      case null:
        break;
    }
    
  }

  function placeObject(planetName, cellLevel, cellNumber, objectType, objectTextureName, ownerColor) {
    const target = getCell(planetName, cellLevel, cellNumber).children[0].rows[0].cells[objectType]
    target.className = objectTextureName
  }

  function setBuilding(cell, objectTextureName) {
    planet = cell.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode
    cell.className = objectTextureName
  }

  function setUnit(cell, objectTextureName) {
    planet = cell.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode
    //TODO check prev and recount affinities
    cell.className = objectTextureName
    TPlanet.params.update(planet, EUnits.list[objectTextureName], EUnits.list[objectTextureName][2])
  }

  function setBiome(cell, biomeName) {
    const planet = cell.parentNode.parentNode.parentNode
    //TODO check prev and recount affinities
    if(cell.className) {
      TPlanet.params.update(planet, EBiomes.list[cell.className], EBiomes.list[cell.className][2], true)
    }
    cell.className = biomeName
    updatePlanetResources(planet, EObjTypes.biome, biomeName)
  }

  function countBiomeRelations(biome1, biome2) {
    let 
      p1 = EBiomes.relations[biome1], 
      p2 = EBiomes.relations[biome2]
    return Math.abs(p1[0]-p2[0])+Math.abs(p1[1]-p2[1])
  }

  function updatePlanetResources(planet, objType, objName, revert = false) {
    let affinityStr, resourceStr
    switch(objType) {
      case EObjTypes.biome:
        affinityStr = EBiomes.list[objName][2]
        resourceStr = EBiomes.list[objName].slice(0,2)
        //FIXME move this to initialization
        if(!EBiomes.list[objName][3].includes(EBiomeSpecials.isSky)) {
          resourceStr[0] += BASE_FOOD
          resourceStr[1] += BASE_METAL 
        }
        break;
      case EObjTypes.unit: 
        break;
      case EObjTypes.building: 
        break;
    }
    TPlanet.params.update(planet, resourceStr, affinityStr, revert)
  }

  function getPlanetResources(planetName) {
    const el = getEl(planetName)
    if(!el) return null
    return Array.from(el.querySelector('.resources').cells)
      .map(e => e.innerText)
  }

  function updateEmpireResources(empireName, resources, invert = false) {
    const root = document.querySelector(`#${empireName}.empire`)
    if(!invert) {
      root.qs('.food-income').innerText  = +root.qs('.food-income').innerText + +resources[0]
      root.qs('.ore-income').innerText   = +root.qs('.ore-income').innerText  + +resources[1]
    } else {
      root.qs('.food-income').innerText  
        = Math.max(+root.qs('.food-income').innerText - +resources[0], 0)
      root.qs('.ore-income').innerText   
        = Math.max(+root.qs('.ore-income').innerText  - +resources[1], 0)
    }
  }

  function getCell(planetName, cellLevel, cellNumber) {
    return getEl(planetName).rows[cellLevel].cells[cellNumber]
  }

  function getCellByXY(x, y) {
    return map.tBodies[0].rows[y].cells[x+1]
  }

  function editName(el) {
    if(el instanceof Event) el = el.target
    const res = prompt("", el.innerHTML)
    if(!res) return
    if(getEl(res) && res != el.innerHTML) {
      alert('Нельзя, имя неуникально: '+res)
      return
    }
    getEl(el.innerHTML).id = capitalizeString(res)
    el.innerHTML = capitalizeString(res)
    //after name first set - we never change it, we only select empire
    el.onclick = selectEmpireOnEl
    selectEmpireOnEl(el)
  }

  const choosingHomeworld = {
    start: function(el) {
      el.innerText = '?'
      choosingHomeworld.el = el
    },
    done: function (el) {
      const empireName = choosingHomeworld.el.parentNode.parentNode.rows[0].cells[0].innerText
      choosingHomeworld.el.innerText = el.innerText
      setPlanetOwner(el, empireName)
      choosingHomeworld.el = null
    },
    getEmpireName: function () {
      return 
    },
    el: null
  }

  function editEmpireName(el) {
    if(el instanceof Event) el = el.target
    const newName = prompt("", el.innerHTML)
    if(!newName) return
    getEl(el.innerHTML).id = newName
    el.innerHTML = newName
  }

  function selectEmpireOnEl(el) {
    if(el instanceof Event) el = el.target
    if(choosingHomeworld.el) {
      //we're choosing homeworld
      choosingHomeworld.done(el)
      return
    }
    let objs = Object.keys(getEmpiresList().colors)
    let t = prompt( "Выбрать империю:\n- - удалить\n"+objs.map((e,i)=>i+' - '+e).join('\n'))
    if(t && objs[t]) {
        setPlanetOwner(el, objs[t])
      } else if(t == '-') {
        setPlanetOwner(el, null)
      }
    }

  function getEmpiresList() {
    //TODO replace with refreshing JS structure instead of html parsing every time
    //TODO add when testing ends: .empires-list>
    const empires = Array.from(document.querySelectorAll('.empire'))
    let res = {
      colors: {}
    }
    empires.forEach( el => {
      res.colors[ el.querySelector('.empire-name').innerHTML ] 
        = el.querySelector('.empire-color').innerText.trim()     
    })
    return res
  }

  function setPlanetOwner(nameEl, empireName) {
    const list = getEmpiresList().colors
    const invList = swapKnV(list)
    const ress = getPlanetResources(nameEl.innerText)
    let bgs = nameEl.parentNode.style
    if(list[empireName] 
      && bgs.backgroundColor == list[empireName]
    ) return null

    if(invList[bgs.backgroundColor]) {
      updateEmpireResources(invList[bgs.backgroundColor], ress, true)
    }
    // if(nameEl.parentNode.style.backgroundColor)
    //TODO add empire statistics changing
    //TODO replace with changing empire class, see empires-stylesheet
    if(empireName) {
      bgs.backgroundColor = list[empireName]
      updateEmpireResources(empireName, ress)
    }
    else
      bgs.backgroundColor = 'transparent'
  }

  function swapKnV(obj) {
    return Object.fromEntries(
      Object.entries(obj).map( ([k, v]) => [v, k])
    )
  }

  function edit(el) {
    const res = prompt("", el.innerHTML)
    if(res) el.innerHTML = res
  }

  function capitalizeString(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
  }
 
  function savePage() {
    downloadhref.href = 'data:application/xml;charset=utf-8, '+allPage.innerHTML;
    downloadhref.click();
  }

  function loadPage() {
    allPage.innerHTML=prompt('Весь текст из файла сюда');
  }

  function init() {

    map.createTHead()
    map.createTBody()

    map.tHead.insertRow(0)
    for(let j=0; j<COLS_COUNT; j++)  {
      map.tHead.rows[0].insertCell(0);
      map.tHead.rows[0].cells[0].classList = 'map-border';
      map.tHead.rows[0].cells[0].innerHTML = COLS_COUNT-j-1;
    }
    map.tHead.rows[0].insertCell(0);
    map.tHead.rows[0].cells[0].classList = 'map-border'
    map.tHead.rows[0].cells[0].innerHTML = ''

    for(let i=0; i<ROWS_COUNT; i++)  {
      let y = ROWS_COUNT-i-1, x = 0
      
      map.tBodies[0].insertRow(0)
      for(let j=0; j<COLS_COUNT; j++)  {
        x = COLS_COUNT-j-1
        map.tBodies[0].rows[0].insertCell(0);
        // if(i%2==1 && j%2==0 || i%2==0 && j%2==1) continue
        map.tBodies[0].rows[0].cells[0].innerHTML = getEl('planet-template').innerHTML

        TPlanet.populate(map.tBodies[0].rows[0].cells[0].children[0], x, y)
      }
      map.tBodies[0].rows[0].insertCell(0);
      map.tBodies[0].rows[0].cells[0].classList= 'shakal map-border'
      map.tBodies[0].rows[0].cells[0].innerHTML = y;
    }

    for(let i of Array.from(document.querySelectorAll('.cell>tbody>tr>td'))) {
      i.onclick = onCellClick
    }

    for(let i of Array.from(document.querySelectorAll('.belongs>.name'))) {
      i.onclick = editName
    }

    for(let i of Array.from(document.querySelectorAll('.empire-name'))) {
      i.onclick = editEmpireName
    }

    for (const i in EBuildings.list) {
      buildings_test.innerHTML += `<td class='${i}'>`
    }

    for (const i in EUnits.list) {
      units_test.innerHTML += `<td class='${i}'>`
    }

    // placeObject("Земля", 0,1,1,"летучий")
    // placeObject("Земля", 1,1,0,"building")
    // placeObject("Земля", 1,1,1,"мечник")
    // setBiome("Земля", 1,1,"льды")
  }
  document.body.onload = init

</script>
</html>
