<html>
  <head>
  <meta http-equiv="CONTENT-TYPE" content="text/html; charset=UTF-8" />
  <link href="misc/w3.css" type="text/css" rel="stylesheet" />
  <link href="misc/w3-theme-amber.css" type="text/css" rel="stylesheet" />
  <TITLE></TITLE>
  <style>
    body {
      padding: 0;
    }

    table {
      text-align: center;
    }

    #main-menu {
      position: fixed;
      left: 4px;
      top: 4px;
      width: 5px;
      height: 5px;
      border: 1px solid black;
    }

    #main-menu:hover {
      width: auto;
      height: auto;
    }

    #map {
      border-collapse: collapse;
    }
    
    #map>thead>tr>td {
    }

    #map>tbody>tr>td {
      padding: 6px;
      /* border: 1px solid black; */
    }

    .shakal {
      width:auto !important;
      min-width:5px !important;
    }

    .map-border {
      background-color: lightgrey;
      border: 1px solid black;
    }

    .planet {
      border-collapse: collapse;
      background-color: white;
      border: 1px solid black;
    }

    .planet>tbody>tr {
      height: 32px;
    }

    .planet tr td {
      border: 1px solid black;
      width: 64px;
      max-width: 64px;
    }
    
    .cell td {
      width: 49%;
      height: 26px;
      border: 0 !important;
      background-size:cover;
    }

    .planet .belongs {
      height: 19px;
    }

    .planet .name {
      overflow: hidden;
    }

    .planet .affinities, .planet .resources {
      height: 22px;
    }

    .affinities>td, .resources>td {
      width: 25% !important;
    }

    .мечник     { background-image: url(images/units/мечник.png); }
    .ладья      { background-image: url(images/units/ладья.png); }
    .летучий    { background-image: url(images/units/летучий.png); }

    .building   { background-image: url(images/buildings/building.png); }
    .Столица    { background-image: url(images/buildings/building.png); }
    .Ферма      { background-image: url(images/buildings/building.png); }
    
    /* биомы */
    .лес          { background-color: #808000aa; }
    .пустыня      { background-color: #ffcc00aa; }
    .льды         { background-color: #99ccffaa; }
    .пустошь      { background-color: #c0c0c0aa; }

    .Асгард       { background-color: #00f000aa; }
    .Муспелльхейм { background-color: #ff6600aa; }
    .Нифльхейм    { background-color: #00ffffaa; }
    .Хельхейм     { background-color: #808080aa; }

    .небо         { background:white;           }

    .цвет-боги    { background:lightyellow;     }
    .цвет-огонь   { background:lightcoral;      color: white;}
    .цвет-лёд     { background:lightblue;       }
    .цвет-смерть  { background:grey;            color: white;}
    
  </style>

</head>
<script>
  
</script>

<body class="w3-theme-l2 w3-padding" style="overflow:auto">

  <div id="allPage">
    <table id="map" contenteditable="true"></table>
    <div id="empires" contenteditable="true"></div>
  </div>

    <br><br><br>
    <div id="main-menu-" hidden2>
      <button onclick="saveMap()">Save</button>
      <button onclick="loadMap()">Load</button>
    </div>
  
    <div id="planet-template" hidden>
      <table class="planet" id="Земля">
        <tr class="affinities" colspan=4>
          <td class="цвет-боги  "></td>
          <td class="цвет-огонь "></td>
          <td class="цвет-лёд   "></td>
          <td class="цвет-смерть"></td>
        </tr>
        <tr>
          <td colspan=2>
            <table class="cell">
              <td>&nbsp;</td>
              <td>&nbsp;</td>
            </table>
          </td>
          <td colspan=2>
            <table class="cell">
              <td>&nbsp;</td>
              <td>&nbsp;</td>
            </table>
          </td>
        </tr>
        <tr>
          <td colspan=2>
            <table class="cell">
              <td>&nbsp;</td>
              <td>&nbsp;</td>
            </table>
          </td>
          <td colspan=2>
            <table class="cell">
              <td>&nbsp;</td>
              <td>&nbsp;</td>
            </table>
          </td>
        </tr>
        <tr class="belongs"><td class="name" colspan=4 onclick="editName(this)"></td></tr>
        <tr class="resources" colspan=4>
          <td -style="background-color: green;"    ></td>
          <td style="background-color: burlywood;"></td>
          <td -style="background-color: lightgrey;"></td>
          <td class="цвет-боги"                     ></td>
        </tr>
      </table>
    </div>

    <div id="empire-template" hidden>

    </div>

    <div id="unit-template" hidden></div>
    <div id="building-template" hidden></div>

    <a id='downloadhref' hidden download="map.AnRSave.txt"></a>
</body>

<script>
  //Divine, Fire, Ice, Necro

  const ROWS_COUNT = 7
  const COLS_COUNT = 11

  const LAYERS_COUNT = 4
  const CELLS_COUNT = 2

  const EObjTypes = {
    biome     : 'biome',
    unit      : 'unit',
    building  : 'building',
  }

  const EResourceTypes = {
    food : 'food',
    metal : 'metal',
    souls : 'souls',
    pantheon : 'pantheon',
  }

  const EBiomeSpecials = {
    isSky: "небо",
    //advanced biome
    isAdv: "улучш.",
  }

  const INITIAL_RESOURCES = {
    PLANET: [0, 0, 3, 0],
    EMPIRE: [5, 5, 0, 0]
  }
  const BASE_FOOD   = 2
  const BASE_METAL  = 2
  //food modifier, gold?/metal modifier, affinity string, special
  const EBiomes = {
    list: {
      'лес':          [2, 0, 'D'    , []  ],
      'пустыня':      [1, 0, 'F'    , []  ],
      'льды':         [1, 0, 'I'    , []  ],
      'пустошь':      [0, 1, 'N'    , []  ],

      'Асгард':       [2, 0, 'DD'   , []  ],
      'Муспелльхейм': [1, 1, 'FFFF' , []  ],
      'Нифльхейм':    [1, 1, 'IIII' , []  ],
      'Хельхейм':     [0, 3, 'NNN'  , []  ],

      'небо'        : [0, 0, ''     , ['небо']  ],
      'цвет-боги'   : [0, 0, ''     , ['небо']  ],
      'цвет-огонь'  : [0, 0, ''     , ['небо']  ],
      'цвет-лёд'    : [0, 0, ''     , ['небо']  ],
      'цвет-смерть' : [0, 0, ''     , ['небо']  ],
    },
    base: [
      'лес',    
      'пустыня',
      'льды'  ,
      'пустошь',
    ],
    relations: {
      'лес':          [1, 0],
      'Асгард':       [2, 0],
      'цвет-боги'   : [1, 0],

      'пустыня':      [0, 1],
      'Муспелльхейм': [0, 2],
      'цвет-огонь'  : [0, 1],

      'льды':         [0, -1],
      'Нифльхейм':    [0, -2],
      'цвет-лёд'    : [0, -1],
      
      'пустошь':      [-1, 0],
      'Хельхейм':     [-2, 0],
      'цвет-смерть' : [-1, 0],

      'небо'        : [0, 0],
    }
  }

  // ATK, DEF, MAINTANCE, SPECIAL
  const EUnits = {
    list: {
      "мечник"  : [],
      "ладья"   : [],
      "летучий" : [],
      // Divine
      // Fire
      // Ice
      // Necromancy
    }
  }

  // prereq, cost, completionEffects[resources, affinities, other], lastingEffects
  const EBuildings = {
    list: {
      "Столица"       : ["", 0, [], []],
      "Ферма"         : ["", 0, [], []],
      // Divine
      // Fire
      "Ферма"         : ["", 0, [], []],
      // Ice
      // Necromancy
    }
  }

  const EAffinities = {
    dict: {
      'D': 0,
      'F': 1,
      'I': 2,
      'N': 3,
    }
  }

  const mapEditorData = {
    mode: null,
    brush: null
  }

  const log = console.log

  const TPlanet = {
    populate: function(planet, x, y) {
      let i
      //belongs to
      planet.id = `${x}_${y}`
      planet.rows[3].cells[0].innerHTML = planet.id 

      //sky
      i = 1
      for(let j=0; j<CELLS_COUNT; j++)  {
        setBiome(planet.rows[i].cells[j], 'небо')
      }
      
      //ground
      i = 2
      for(let j=0; j<CELLS_COUNT; j++)  {
        setBiome(planet.rows[i].cells[j], EBiomes.base[getRandomInt(0,3)])
      }

      changeResources(planet, INITIAL_RESOURCES.PLANET)
    }
  }

  class TPlanets {
    constructor() {
      this.planets = []
    }

    newPlanet(x, y) {
      const p = {
        name: `${x}_${y}`,
        x, y,
        owner: null,
        cells: [
          [ [null,null, 'небо'], [null,null, 'небо'] ],
          [ [null,null, ''], [null,null, ''] ],
        ]
      }
    }
  }

  function getEl(name) {
    return document.getElementById(name)
  }

  function getRandomInt(min, maxInclusive) {
    min = Math.ceil(min);
    maxInclusive = Math.floor(maxInclusive);
    return Math.floor(Math.random() * (maxInclusive - min + 1)) + min;
  }

  function onCellClick() {
    let t, arr
    if(this.nextSibling.nextSibling) {
      //left, building
      //if building exists - upgrade?
      arr = Object.keys(EBuildings.list)
      t = prompt("Новое здание:\n- - удалить\n"+arr.map((e,i)=>i+' - '+e).join('\n'))
      if(t && arr[t]) {
        setBuilding(this, arr[t])
      } else if(t == '-') {
        setBuilding(this, '')
      }
    } else {
      // right, unit
      arr = Object.keys(EUnits.list)
      t = prompt("Новый юнит:\n- - удалить\n"+arr.map((e,i)=>i+' - '+e).join('\n'))
      if(t && arr[t]) {
        setUnit(this, arr[t])
      } else if(t == '-') {
        setUnit(this, '')
      }
    }
    return

    switch (mapEditorData.mode) {
      case 'biomes':
        if(!mapEditorData.brush) 
          this.classList = "";
        else
          this.classList = mapEditorData.brush;
        break;
      case 'units':
        if(applyUnit == "Сброс") 
          getUnit(this).innerHTML = "";
        else
          getUnit(this).innerHTML = createUnit(applyUnit)
        break;
      case 'empires':
        if(applyEmpire == "Сброс") 
          setEmpire(this, "");
        else
          setEmpire(this, applyEmpire);
        break;
      case null:
        break;
    }
    
  }

  function placeObject(planetName, cellLevel, cellNumber, objectType, objectTextureName, ownerColor) {
    const target = getCell(planetName, cellLevel, cellNumber).children[0].rows[0].cells[objectType]
    target.className = objectTextureName
  }

  function setBuilding(cell, objectTextureName) {
    planet = cell.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode
    cell.className = objectTextureName
  }

  function setUnit(cell, objectTextureName) {
    planet = cell.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode
    //TODO check prev and recount affinities
    cell.className = objectTextureName
    changeAffinity  (planet, EUnits.list[objectTextureName][2])
    changeResources (planet, EUnits.list[objectTextureName])
  }

  function setBiome(cell, biomeName) {
    const planet = cell.parentNode.parentNode.parentNode
    //TODO check prev and recount affinities
    if(cell.className) {
      changeAffinity  (planet, EBiomes.list[cell.className][2], true)
      changeResources (planet, EBiomes.list[cell.className], true)
    }
    cell.className = biomeName
    updatePlanetResources(planet, EObjTypes.biome, biomeName)
  }

  function countBiomeRelations(biome1, biome2) {
    let 
      p1 = EBiomes.relations[biome1], 
      p2 = EBiomes.relations[biome2]
    return Math.abs(p1[0]-p2[0])+Math.abs(p1[1]-p2[1])
  }

  function updatePlanetResources(planet, objType, objName, revert = false) {
    let affinityStr, resourceStr
    switch(objType) {
      case EObjTypes.biome:
        affinityStr = EBiomes.list[objName][2]
        resourceStr = EBiomes.list[objName].slice(0,2)
        //FIXME move this to initialization
        if(!EBiomes.list[objName][3].includes(EBiomeSpecials.isSky)) {
          resourceStr[0] += BASE_FOOD
          resourceStr[1] += BASE_METAL 
        }
        break;
      case EObjTypes.unit: 
        break;
      case EObjTypes.building: 
        break;
    }
    changeAffinity  (planet, affinityStr, revert)
    changeResources (planet, resourceStr, revert)
  }

  function changeAffinity(planet, affinityString, revert = false) {
    affinityString = affinityString.trim()
    if(!affinityString) return
    // let total = {}
    // const d = affinityString
    //   .toUpperCase()
    //   .split('')
    //   .forEach(x => total[x] ? total[x]+=1 : total[x]=1 )
    const target = planet.querySelector('.affinities').children[EAffinities.dict[affinityString.charAt()]]
    if(!target.innerText) target.innerText = 0
    if(!revert)
      target.innerText = +target.innerText + affinityString.length
    else
      target.innerText = +target.innerText - affinityString.length

    if(+target.innerText <= 0) target.innerText = ''
  }

  //food, metal, two types of souls
  function changeResources(planet, resourceArray, revert = false) {
    const list = planet.querySelector('.resources').children

    for (let i in list) {
      if(!resourceArray[i]) continue
      if(!list[i].innerText) list[i].innerText = 0
      list[i].innerText = +list[i].innerText + resourceArray[i]
    }
  }

  function getCell(planetName, cellLevel, cellNumber) {
    return getEl(planetName).rows[cellLevel].cells[cellNumber]
  }

  function getCellByXY(x, y) {
    return map.tBodies[0].rows[y].cells[x+1]
  }

  function editName(el) {
    const res = prompt("", el.innerHTML)
    if(res) el.innerHTML = capitalizeString(res)
  }

  function edit(el) {
    const res = prompt("", el.innerHTML)
    if(res) el.innerHTML = res
  }

  function capitalizeString(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
  }
 
  function savePage() {
    downloadhref.href = 'data:application/xml;charset=utf-8, '+allPage.innerHTML;
    downloadhref.click();
  }

  function loadPage() {
    allPage.innerHTML=prompt('Весь текст из файла сюда');
  }

  function init() {

    map.createTHead()
    map.createTBody()

    map.tHead.insertRow(0)
    for(let j=0; j<COLS_COUNT; j++)  {
      map.tHead.rows[0].insertCell(0);
      map.tHead.rows[0].cells[0].classList = 'map-border';
      map.tHead.rows[0].cells[0].innerHTML = COLS_COUNT-j-1;
    }
    map.tHead.rows[0].insertCell(0);
    map.tHead.rows[0].cells[0].classList = 'map-border'
    map.tHead.rows[0].cells[0].innerHTML = ''

    for(let i=0; i<ROWS_COUNT; i++)  {
      let y = ROWS_COUNT-i-1, x = 0
      
      map.tBodies[0].insertRow(0)
      for(let j=0; j<COLS_COUNT; j++)  {
        x = COLS_COUNT-j-1
        map.tBodies[0].rows[0].insertCell(0);
        if(i%2==1 && j%2==0 || i%2==0 && j%2==1) continue
        map.tBodies[0].rows[0].cells[0].innerHTML = getEl('planet-template').innerHTML

        TPlanet.populate(map.tBodies[0].rows[0].cells[0].children[0], x, y)
      }
      map.tBodies[0].rows[0].insertCell(0);
      map.tBodies[0].rows[0].cells[0].classList= 'shakal map-border'
      map.tBodies[0].rows[0].cells[0].innerHTML = y;
    }

    for(let i of Array.from(document.querySelectorAll('.cell>tbody>tr>td'))) {
      i.onclick = onCellClick
    }

    // placeObject("Земля", 0,1,1,"летучий")
    // placeObject("Земля", 1,1,0,"building")
    // placeObject("Земля", 1,1,1,"мечник")
    // setBiome("Земля", 1,1,"льды")
  }
  document.body.onload = init

</script>
</html>
